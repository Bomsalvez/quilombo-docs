# ğŸ”‘ RF15 - Alterar Senha

![Logo.png](Logo.png){ width=150 }

## ğŸ“ DescriÃ§Ã£o

Este requisito funcional permite que os operadores alterem sua prÃ³pria senha ou, no caso de administradores, tambÃ©m possam redefinir senhas de outros operadores. A funcionalidade garante a seguranÃ§a das contas e possibilita a recuperaÃ§Ã£o de acesso em casos de esquecimento de senha, mantendo a integridade do controle de acesso ao sistema Quilombo Pena Branca.

## ğŸ‘‘ Atores

- Operador (alterar prÃ³pria senha)
- Administrador (alterar prÃ³pria senha e redefinir senhas de outros operadores)

## âœ… PrÃ©-condiÃ§Ãµes

- O operador deve estar autenticado no sistema para alterar sua prÃ³pria senha
- O administrador deve estar autenticado para redefinir senhas de outros operadores
- Para alteraÃ§Ã£o da prÃ³pria senha, o operador deve conhecer sua senha atual

## ğŸŒ Endpoints

- `PATCH /api/v1/users/{id}/reset-password` (administrador redefine senha de operador)
- `PATCH /api/v1/users/change-default-password` (primeiro acesso - trocar senha padrÃ£o)


## ğŸ“Š Dados para RedefiniÃ§Ã£o de Senha pelo Administrador

| Campo              | Tipo    | ObrigatÃ³rio | RestriÃ§Ãµes                                        |
|--------------------|---------|-------------|---------------------------------------------------|
| userId             | Long    | âœ“           | ID do operador existente                          |
| newPassword        | String  | âœ“           | MÃ­nimo 8 caracteres, deve conter letras e nÃºmeros |
| confirmNewPassword | String  | âœ“           | Deve ser igual a newPassword                      |
| forceChange        | Boolean | âŒ           | Default: true (forÃ§a troca no primeiro login)     |

## ğŸ“Š Dados para MudanÃ§a de Senha PadrÃ£o (Primeiro Acesso)

| Campo              | Tipo   | ObrigatÃ³rio | RestriÃ§Ãµes                                        |
|--------------------|--------|-------------|---------------------------------------------------|
| defaultPassword    | String | âœ“           | Senha padrÃ£o fornecida inicialmente               |
| newPassword        | String | âœ“           | MÃ­nimo 8 caracteres, deve conter letras e nÃºmeros |
| confirmNewPassword | String | âœ“           | Deve ser igual a newPassword                      |


## ğŸ”„ Fluxo Principal - Administrador Redefine Senha

```mermaid
sequenceDiagram
    participant A as Administrador
    participant S as Sistema
    participant DB as Banco de Dados
    
    A->>S: Acessa a lista de operadores
    S->>A: Exibe lista de operadores
    A->>S: Seleciona um operador
    S->>A: Exibe detalhes do operador
    A->>S: Clica em "Redefinir Senha"
    S->>A: Exibe formulÃ¡rio para nova senha
    A->>S: Define nova senha e opÃ§Ã£o de forÃ§ar troca
    A->>S: Clica em "Confirmar"
    S->>S: Valida requisitos da nova senha
    S->>DB: Atualiza senha (hash) e flag de redefiniÃ§Ã£o
    DB->>S: Confirma alteraÃ§Ã£o
    S->>A: Exibe mensagem de sucesso
    S->>DB: Registra aÃ§Ã£o em log de auditoria
```

## ğŸ”„ Fluxo Principal - Mudar Senha PadrÃ£o (Primeiro Acesso)

```mermaid
sequenceDiagram
    participant O as Operador
    participant S as Sistema
    participant DB as Banco de Dados
    
    O->>S: Faz login com senha padrÃ£o/temporÃ¡ria
    S->>DB: Verifica flag de senha temporÃ¡ria
    DB->>S: Confirma que senha Ã© temporÃ¡ria
    S->>O: Redireciona para tela de troca obrigatÃ³ria
    O->>S: Preenche senha atual e nova senha
    O->>S: Clica em "Salvar"
    S->>DB: Verifica senha atual
    DB->>S: Confirma senha atual
    S->>S: Valida requisitos da nova senha
    S->>DB: Atualiza senha (hash) e remove flag
    DB->>S: Confirma alteraÃ§Ã£o
    S->>O: Exibe mensagem de sucesso
    S->>O: Redireciona para pÃ¡gina inicial do sistema
```

## ğŸ”€ Fluxos Alternativos

### 1. Senha atual incorreta

```mermaid
sequenceDiagram
    participant O as Operador
    participant S as Sistema
    participant DB as Banco de Dados
    
    O->>S: Informa senha atual incorreta
    O->>S: Clica em "Salvar"
    S->>DB: Verifica senha atual
    DB->>S: Senha nÃ£o confere
    S->>O: Exibe mensagem "Senha atual incorreta"
    S->>O: MantÃ©m no formulÃ¡rio de alteraÃ§Ã£o
```

### 2. Nova senha nÃ£o atende aos requisitos

```mermaid
sequenceDiagram
    participant O as Operador
    participant S as Sistema
    
    O->>S: Informa nova senha que nÃ£o atende requisitos
    O->>S: Clica em "Salvar"
    S->>S: Valida requisitos da nova senha
    S->>O: Exibe mensagem detalhando requisitos nÃ£o atendidos
    S->>O: MantÃ©m no formulÃ¡rio de alteraÃ§Ã£o
```

### 3. ConfirmaÃ§Ã£o de senha nÃ£o coincide

```mermaid
sequenceDiagram
    participant O as Operador
    participant S as Sistema
    
    O->>S: Informa senhas diferentes nos campos de nova senha e confirmaÃ§Ã£o
    O->>S: Clica em "Salvar"
    S->>S: Verifica se senhas coincidem
    S->>O: Exibe mensagem "As senhas nÃ£o coincidem"
    S->>O: MantÃ©m no formulÃ¡rio de alteraÃ§Ã£o
```

## ğŸ“„ Exemplos de RequisiÃ§Ã£o e Resposta

### Redefinir senha de operador (Administrador)

**RequisiÃ§Ã£o:**
```http
PATCH /api/v1/users/42/reset-password HTTP/1.1
Host: api.quilombopenabranca.org
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

{
  "newPassword": "Temp@2023",
  "confirmNewPassword": "Temp@2023",
  "forceChange": true
}
```

**Resposta:**
```json
{
  "message": "Senha do operador redefinida com sucesso",
  "userId": 42,
  "userName": "JoÃ£o Silva",
  "forcePasswordChange": true,
  "timestamp": "2023-05-21T16:10:22Z"
}
```

## ğŸ–¼ï¸ Interfaces de ReferÃªncia

![reset_senha.png](reset_senha.png)

![senha_default.png](senha_default.png)

## ğŸ” ConsideraÃ§Ãµes de SeguranÃ§a

- **Armazenamento Seguro**: Senhas devem ser armazenadas utilizando algoritmos de hash seguros (BCrypt, Argon2)
- **ForÃ§a da Senha**: O sistema deve verificar a forÃ§a da nova senha, rejeitando senhas fracas ou comuns
- **HistÃ³rico de Senhas**: O sistema deve manter um histÃ³rico para evitar reutilizaÃ§Ã£o de senhas antigas
- **NotificaÃ§Ãµes**: O sistema deve notificar o usuÃ¡rio por e-mail quando sua senha for alterada
- **Tentativas Limitadas**: Bloquear temporariamente apÃ³s mÃºltiplas tentativas incorretas de alteraÃ§Ã£o
- **SessÃµes**: Invalidar todas as sessÃµes ativas do usuÃ¡rio apÃ³s alteraÃ§Ã£o de senha, exceto a sessÃ£o atual

## âš™ï¸ ConfiguraÃ§Ãµes de Senha

| ConfiguraÃ§Ã£o       | Valor PadrÃ£o | DescriÃ§Ã£o                                               |
|--------------------|--------------|---------------------------------------------------------|
| Tamanho mÃ­nimo     | 8 caracteres | Tamanho mÃ­nimo aceito para senhas                       |
| Complexidade       | MÃ©dia        | Exige letras, nÃºmeros e caracteres especiais            |
| ExpiraÃ§Ã£o          | 90 dias      | PerÃ­odo apÃ³s o qual a senha deve ser alterada           |
| HistÃ³rico          | 5 senhas     | NÃºmero de senhas antigas que nÃ£o podem ser reutilizadas |
| Tentativas mÃ¡ximas | 5 tentativas | NÃºmero de tentativas incorretas antes do bloqueio       |

---

  #### ğŸŒ™ Quilombo Pena Branca ğŸŒ™
  Honrando nossas raÃ­zes, construindo nosso futuro